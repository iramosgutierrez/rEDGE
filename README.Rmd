---
output: github_document
editor_options: 
  markdown: 
    wrap: 72
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)

library(ape)
library(dplyr)
devtools::load_all()
```


# EDGEcalc
Package to calculate EDGE scores

<img src="man/figures/EDGEcalc_logo.png" width="140px" align="right"/>


Documentation of website under current development...


## The EDGE index

The EDGE index is a metrric that aims to prioritize species' conservation bsed on both theis phylogenetic singularity (i.e. ED, Evolutionaty Distinctiveness) and their extinction risk (GE, Globally Endangered). Based on this idea, several methods have been developed in order to calculate individual EDGE scores.

To illustrate the differences among methods ant their implementationn within `EDGEcalc` package, we will see some examples using monotremates (i.e. platypus and echidna species).

```{r, include=T, echo=F, out.width="50%"}
t2 <- monotreme.tree
t2$tip.label <- paste0(monotreme.table$species, " (", monotreme.table$RL.cat, ")")
plot.phylo(t2)
```



## EDGE1
Index based on Isaac *et al.*, 2007. \newline
This first approach used evolutionary distinctiveness (ED) and a transformation of extinction risk (GE) in which each IUCN Red List category is twice as probable of becoming extinct. The EDGE score is calculated ussing the following formula:

EDGE = log(1+ED)+GEâˆ—log(2)



To calculate this index for monotremates, we just have to use the `calculate_EDGE1` function specifying uot phylogenetic tree, and a table including all the tree's species (in a clomn named *species*, and their respective IUCN category in a column named *RL.cat*).\newline
Note that all species must be included, so if there are species included on the tree and not evaluated, make sure to include them on the table wit a "NE" category.

```{r EDGE1}


EDGE1 <- calculate_EDGE1(tree = monotreme.tree, 
                         table = monotreme.table, 
                         sort.list = T # to get the list sorted by decreasing EDGE value
                         )

knitr::kable(EDGE1)
```




## EDGE2
In order to take into account the extinction probability of closely related taxa as well as uncertainty in the extinction probability of species, Gumbs *et al.*, 2023 designed a new methodology, termed EDGE2.

In this new approach, a probabilty of extinction is sampled from a continuous distribution based on the IUCN Red List category, and ED2 and EDGE" values can be calculated **(*develop more thoroughly...*)**. 

```{r EDGE2}
EDGE2 <- calculate_EDGE2(tree = monotreme.tree, 
                         table = monotreme.table, 
                         sort.list = T, # to get the list sorted by decreasing EDGE value
                         verbose = F)

knitr::kable(EDGE2)
```

As this EDGE score is iteration dependant (i.e. there is a random factor in the sampling of extinction probabilty), a set of EDGE2 values can be calculated and averaged posteriorly. This multiple calculation is performed by `calculate_EDGE2_multiple` function, which allows to parallelize in order to speed computation times. In this example we are calculating EDGE scores 50 times and averaging the results after.


```{r EDGE2mult, message=F, warning=F}
EDGE2mult <- calculate_EDGE2_multiple(tree = monotreme.tree, 
                                      table = monotreme.table, 
                                      n.iter = 50,
                                      parallelize = TRUE,
                                      n.cores = 10
                                      )

EDGE2mult_summ <- EDGE2mult |> 
  bind_rows()  |> 
  group_by(species) |> 
  summarise(RL.cat = paste0(unique(RL.cat)),
            TBL  = mean(TBL ),
            pext = mean(pext),
            ED   = mean(ED  ),
            EDGE = mean(EDGE) ) |> 
  arrange(desc(EDGE))

knitr::kable(EDGE2mult_summ)
```
